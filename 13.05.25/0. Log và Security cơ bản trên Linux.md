# Logs và Security cơ bản trên Linux
## 1. Các loại Logs quan trọng
- File log là một tập hợp các bản ghi mà Linux duy trì để các quản trị viên theo dõi các sự kiện quan trọng. Các file log này sẽ chứa các thông báo về máy chủ, bao gồm kernel, dịch vụ và ứng dụng đang chạy trên nó. File log cung cấp thời gian của các sự kiện cho hệ điều hành, ứng dụng và hệ thống Linux và là một công cụ quan trọng giúp chúng ta khắc phục sự cố
- Tất cả các hệ thống Linux đều tạo và lưu trữ các tệp nhật ký thông tin cho các quy trình khởi động, ứng dụng và các sự kiện khác. Các tệp này là một nguồn hữu ích để khắc phục sự cố hệ thống.
- Hầu hết các tệp nhật ký Linux được lưu trữ trong các tệp văn bản thuần túy (định dạng ASCII) trong thư mục /var/log và các thư mục con. Nhật ký được tạo bởi system daemon Linux, syslogd hoặc rsyslogd. Quản lý đúng các nhật ký này đảm bảo dữ liệu cần thiết luôn sẵn sàng để phân tích và kiểm tra.
- Phần lớn logs trong Linux được chia thành `4` loại:
	- Log hệ thống (System Logs)
	- Log sự kiện (Event Logs)
	- Log ứng dụng (Application Logs)
	- Log dịch vụ (Service Logs)
### 1.1. System logs
- Nhật ký hệ thống chủ yếu liên quan đến hoạt động của hệ thống Ubuntu, không nhất thiết liên quan đến các ứng dụng bổ sung do người dùng thêm vào. Ví dụ bao gồm cơ chế ủy quyền, daemon hệ thống, thông báo hệ thống và bản ghi hệ thống bao gồm tất cả, syslog.
- Các tệp hệ thống quan trọng có thể kể tên như: 
- Authorization Log (Nhật ký uỷ quyền): Nhật ký ủy quyền theo dõi việc sử dụng các hệ thống ủy quyền, các cơ chế ủy quyền cho người dùng yêu cầu nhập mật khẩu người dùng, chẳng hạn như hệ thống Pluggable Authentication Module(PAM), lệnh sudo, đăng nhập từ xa vào sshd, v.v. Có thể truy cập tệp Nhật ký ủy quyền tại /var/log/auth.log. Nhật ký này hữu ích để tìm hiểu về thông tin đăng nhập của người dùng và cách sử dụng lệnh sudo.
![images](./images/log-3.png)
- Daemon Log (Nhật ký Daemon): Daemon là một chương trình chạy ở chế độ nền, thường không có sự can thiệp của con người, thực hiện một số thao tác quan trọng đối với việc chạy đúng của hệ thống. Nhật ký daemon lưu tại /var/log/daemon.log và chứa thông tin về các daemon hệ thống và ứng dụng đang chạy như daemon Gnome Display Manager gdm, daemon Bluetooth HCI hcid hoặc daemon cơ sở dữ liệu MySQL mysqld. Điều này có thể giúp khắc phục sự cố với một daemon cụ thể.
- Debug Log (Nhật ký gỡ lỗi): Nhật ký gỡ lỗi lưu tại `/var/log/debug` cung cấp các thông báo gỡ lỗi chi tiết từ hệ thống Ubuntu và các ứng dụng được ghi vào syslogd ở cấp độ DEBUG.
- Kernel Log (Nhật ký Kernel): Log này được lưu ở `/var/log/kern.log` chứa các thông báo từ kernel, bao gồm thông tin liên quan đến phần cứng và nhật ký mô-đun kernel.
![images](./images/log-1.png)
- Kernel Ring Buffer Nhật ký này lưu ở `/var/log/dmesg` ghi nhật ký các thông báo từ kernel ring buffer, chủ yếu ghi lại thông tin về quá trình khởi động, phát hiện phần cứng và khởi tạo trình điều khiển.
![images](./images/log-2.png)
- System log (Nhật ký hệ thống): Nhật ký hệ thống thường chứa nhiều thông tin nhất theo mặc định về hệ thống Ubuntu của bạn. Nó nằm tại /var/log/syslog và có thể chứa thông tin mà các nhật ký khác không có. Tham khảo Nhật ký hệ thống khi bạn không thể tìm thấy thông tin nhật ký mong muốn trong nhật ký khác. Nó cũng chứa mọi thứ từng có trong /var/log/messages.
/var/log/syslog và /var/log/messages ghi lại nhiều sự kiện hệ thống, bao gồm các thông báo chung của hệ thống, thông báo từ các dịch vụ hệ thống, lỗi ứng dụng và các sự kiện quan trọng khác.
![images](./images/log-0.png)

### 1.2 Application Logs 
- Nhiều ứng dụng cũng tạo nhật ký trong /var/log. Nếu bạn liệt kê nội dung của thư mục con /var/log, bạn sẽ thấy những cái tên quen thuộc, chẳng hạn như /var/log/apache2 đại diện cho nhật ký của máy chủ web Apache 2 hoặc /var/log/samba, chứa nhật ký của máy chủ Samba. Phần này của hướng dẫn giới thiệu một số ví dụ cụ thể về nhật ký ứng dụng và thông tin có trong đó.
- Apache HTTP Server Logs (Nhật ký máy chủ HTTP Apache): 
	- Cài đặt mặc định cho Apache2 trên Ubuntu tạo một thư mục con lưu log ở `/var/log/apache2`. Trong thư mục con này có hai tệp nhật ký với hai mục đích riêng biệt:
	* /var/log/apache2/access.log - bản ghi của mọi trang được phục vụ và mọi tệp được máy chủ web tải.
	* /var/log/apache2/error.log - bản ghi của mọi điều kiện lỗi được máy chủ HTTP báo cáo
	- Theo mặc định, mỗi khi Apache truy cập một tệp hoặc trang, `access.log` sẽ ghi lại địa chỉ IP, thời gian và ngày tháng, chuỗi nhận dạng trình duyệt, mã kết quả HTTP và văn bản của truy vấn thực tế, thường là GET cho chế độ xem trang.
![images](./images/log-4.png)
	- Ngoài ra, mỗi khi xảy ra bất kỳ lỗi nào, Apache sẽ thêm một dòng vào nhật ký lỗi `error.log`. Nếu bạn chạy PHP với thông báo lỗi và cảnh báo đã tắt, đây có thể là cách duy nhất để xác định lỗi.
![images](./images/log-5.png)
	- CUPS Print System logs: Hệ thống in Unix chung (CUPS) sử dụng tệp nhật ký mặc định `/var/log/cups/error_log` để lưu trữ thông tin và thông báo lỗi. 
	- Rookit hunter log: Tiện ích Rootkit Hunter (rkhunter) kiểm tra hệ thống Ubuntu của bạn để tìm backdoors, sniffers và rootkit, tất cả đều là dấu hiệu xâm phạm hệ thống của bạn. Nhật ký rkhunter sử dụng nằm tại /var/log/rkhunter.log.
	- Samba (SMB) Server Logs: Nhật ký máy chủ Samba SMB: Máy chủ Giao thức khối tin nhắn máy chủ (SMB), Samba thường được sử dụng để chia sẻ tệp giữa máy tính Ubuntu của bạn và các máy tính khác hỗ trợ giao thức SMB. Samba lưu giữ ba loại nhật ký riêng biệt trong thư mục con /var/log/samba:
		- log.nmbd - các thông báo liên quan đến chức năng NETBIOS qua IP của Samba (các thông tin mạng)
		- log.smbd - các thông báo liên quan đến chức năng SMB/CIFS của Samba (các thông tin chia sẻ tệp và bản in)
		- log.[IP_ADDRESS] - các thông báo liên quan đến các yêu cầu dịch vụ từ địa chỉ IP có trong tên tệp nhật ký, ví dụ: log.192.168.1.1.
	- X11 Server Log : Máy chủ cửa sổ X11 mặc định được sử dụng với Ubuntu là máy chủ Xorg X11 và giả sử máy tính của bạn chỉ có một màn hình được xác định, máy chủ này sẽ lưu trữ các thông báo nhật ký trong tệp /var/log/Xorg.0.log. 
### 1.3 Non-Human-Readable Log
- Một số tệp nhật ký được tìm thấy trong thư mục con `/var/log` được thiết kế để các ứng dụng có thể đọc được, không nhất thiết là con người. Một số ví dụ về các tệp nhật ký như vậy xuất hiện trong /var/log như sau.
- Login Failures Log Nhật ký lỗi đăng nhập: Nhật ký lỗi đăng nhập nằm tại /var/log/faillog thực sự được thiết kế để được phân tích cú pháp và hiển thị bởi lệnh faillog. 
- Last Logins Log Nhật ký đăng nhập cuối cùng tại /var/log/lastlog thường không nên được phân tích và kiểm tra bởi con người, mà nên được sử dụng kết hợp với lệnh lastlog
- Login Records Log: Tệp /var/log/wtmp chứa các bản ghi đăng nhập, nhưng không giống như /var/log/lastlog ở trên, /var/log/wtmp không được sử dụng để hiển thị danh sách các lần đăng nhập gần đây mà thay vào đó được các tiện ích khác như lệnh who sử dụng để hiển thị danh sách người dùng hiện đang đăng nhập. Lệnh này sẽ hiển thị những người dùng hiện đang đăng nhập vào máy của bạn:
![images](./images/log-6.png)

### 1.4 Kiểm tra log đăng nhập, reboot/shutdown 
- Auth Log ghi lại các nỗ lực xác thực đăng nhập trên hệ thống 
![images](./images/log-3.png)
- Lệnh who trong Linux có thể hiển thị thông tin liên quan đến đăng nhập của người dùng như tên tài khoản người dùng, thiết bị đầu cuối của người dùng, thời gian đăng nhập của người dùng, tên máy chủ hoặc địa chỉ IP từ nơi người dùng đã đăng nhập.
```
who
```
![images](./images/log-6.png)
- Lệnh `last` trong Linux có thể hiển thị danh sách các lần đăng nhập gần đây của người dùng, thời gian của chúng và thông tin khác được đọc từ tệp `/var/log/wtmp`.
![images](./images/log-7.png)
- Thay vì chỉ định tên người dùng, có thể thay thế nó bằng tham số `reboot` để lấy thời gian và ngày khởi động lại lần cuối trong Linux.
![images](./images/log-8.png)
- Lệnh journalctl trong Linux được sử dụng để truy vấn nhật ký hệ thống, có thể sử dụng lệnh này để hiển thị nhật ký hệ thống để biết thêm thông tin, chẳng hạn như số lần hệ thống đã được khởi động.
```
journalctl --list-boot
```
![images](./images/log-9.png)

## 2. Công cụ quản lý logs
### 2.1. journalctl
#### 2.1.1. journalctl
- journald – systemd journal daemon journalctl là một tiện ích mạnh mẽ để truy vấn và hiển thị nhật ký sự kiện hoặc tệp nhật ký trong Linux. Đây là thành phần trung tâm của bộ quản lý hệ thống và dịch vụ systemd, đi kèm với nhiều bản phân phối Linux như Ubuntu, Fedora và Arch Linux. Tên "journalctl" là sự kết hợp của "journal" (nhật ký) và "ctl" (điều khiển), ám chỉ thực tế là lệnh này được sử dụng để kiểm soát và phân tích nhật ký.
- File cấu hình của journald được lưu ở đường dẫn /etc/systemd/journald.conf. Nó rất nhiều tham số để cho chúng ta biết quá trình logging diễn ra như thế nào.
- journald lưu trữ các files log ở dạng mã nhị phân, nó được lưu trữ ở đường dẫn /var/log/journal.
![images](./images/jo-0.png)

#### 2.1.2. Sử dụng journalctl để đọc và phân tích Systemd Logs
- Lệnh xem log cơ bản
```
journalctl
```
![images](./images/jo-1.png)
- Sử dụng `journald` theo múi giờ: Mặc định journalctl hiện thị log theo múi giờ hiện tại nhưng có thể yêu cầu chương trình hiển thị ở múi giờ khác vi dụ để xem ở múi giờ UTC
```
journalctl --utc
```
![images](./images/jo-2.png)
- Chỉ xem log errow, warnings: Logs mà hệ thống xuất ra có những mức ưu tiên khác nhau. Nhiều Logs chỉ là cảnh báo có thể không cần quan tâm, nhưng một số logs là mỗi nghiêm trọng. Sử dụng lệnh sau 
	```
	journalctl -p <code>
	```
	- Trong đó `<code>` gồm các options 
		- 0: emergency
		- 1: alerts
		- 2: critical
		- 3: errors
		- 4: warning
		- 5: notice
		- 6: info
		- 7: debug 
![images](./images/jo-3.png)
- Xem journal logs cho một thời gian, khoảng thời gian cụ thể: Có thể dùng tham số --since với các giá tị như “yesterday”, “today”, “tomorrow”, “now”. Hoặc với khoảng thời gian cụ thể theo định dạng “YYYY-MM-DD HH:MM:SS”
```
journalctl --since "2020-12-04 06:00:00"
journalctl --since "2020-12-03" --until "2020-12-05 03:00:00"
journalctl --since yesterday
journalctl --since 09:00 --until "1 hour ago"
```
![images](./images/jo-4.png)
- Xem journal logs về kernel
```
journalctl -k
```
![images](./images/jo-5.png)
- Xem journal logs của một Service, PID
```
journalctl -u apach2.service
```
- Xem journal logs của một user,group: Dùng câu lệnh `id -u` để tìm ID của user/group đó
	```
	id -u ubuntu
	```
![images](./images/jo-7.png)
	
	- Sau đó dùng tham số _UID cho User và _GID cho Group để xem
	```
	journalctl _UID=1001 --since today
	```
![images](./images/jo-8.png)
- Xem journal logs của một thực thi
```
journalctl /usr/bin/gnome-shell --since today
```

### 2.2.logrotate:
- LogRotate là một công cụ trên hệ điều hành Linux dùng để quản lý file log. Nó giúp xử lý và lưu trữ file log một cách tự động, giúp tránh file log quá lớn và gây tắc nghẽn hệ thống. LogRotate cung cấp một số tùy chọn cấu hình để quản lý file log như xóa các file log cũ, nén các file log đã quá hạn, xác định tần suất xử lý file log và kích thước tối đa của file log trước khi xử lý.
![images](./images/ro-1.png)

### 2.3.rsyslog/syslog-ng:
3. Security cơ bản trên Linux
Bảo mật đăng nhập:
Quản lý user và quyền:
Firewall (Tường lửa):
Cập nhật hệ thống:
Giám sát hệ thống:
4. Phân tích logs để phát hiện tấn công


https://help.ubuntu.com/community/LinuxLogFiles
https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs